<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control v2.0</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #252532;
            --bg-sidebar: #0d0d14;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --positive: #10b981;
            --negative: #ef4444;
            --border: #27272a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            overflow-y: auto;
        }
        
        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }
        
        .nav-item {
            padding: 0.625rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent);
            color: white;
        }
        
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .view { display: none; }
        .view.active { display: block; }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .portfolio-table th {
            text-align: left;
            padding: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
        }
        
        .portfolio-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .portfolio-table tr:hover {
            background: var(--bg-hover);
        }
        
        .ticker {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        
        .expand-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .accounts-detail {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .refresh-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .refresh-btn:hover { background: var(--accent-hover); }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .total-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
        }
        
        .total-card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .total-card-value {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .analysis-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .analysis-card:hover {
            border-color: var(--accent);
        }
        
        .analysis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .analysis-card-ticker {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .analysis-card-grade {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .analysis-card-summary {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 60px;
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .sidebar-title {
                display: none;
            }
            
            .nav-item {
                white-space: nowrap;
                margin: 0 0.25rem;
                padding: 0.5rem 0.75rem;
            }
            
            .main {
                padding: 1rem;
                height: calc(100vh - 60px);
            }
            
            .portfolio-table {
                font-size: 0.75rem;
            }
            
            .portfolio-table th,
            .portfolio-table td {
                padding: 0.5rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-title">Menu</div>
            <div class="nav-item active" onclick="showView('holdings')">Holdings</div>
            <div class="nav-item" onclick="showView('analysis')">Analysis</div>
            <div class="nav-item" onclick="showView('earnings')">Earnings</div>
            <div class="nav-item" onclick="showView('ideas')">Ideas</div>
            <div class="nav-item" onclick="showView('schedule')">Schedule</div>
            <div class="nav-item" onclick="showView('corporate')">Corporate</div>
            <div class="nav-item" onclick="showView('usage')">APIs</div>
        </nav>
        
        <main class="main">
            <!-- HOLDINGS TAB -->
            <div id="holdings-view" class="view active">
                <div id="holdings-content">
                    <div class="loading">Loading portfolio...</div>
                </div>
            </div>
            
            <!-- ANALYSIS TAB -->
            <div id="analysis-view" class="view">
                <div style="margin-bottom: 1.5rem;">
                    <h2 style="margin-bottom: 1rem;">Stock Analysis Archive</h2>
                    <input type="text" class="search-box" id="analysis-search" placeholder="Search..." onkeyup="filterAnalysis()">
                </div>
                <div id="analysis-content">
                    <div class="loading">Loading analysis...</div>
                </div>
            </div>
            
            <!-- EARNINGS TAB -->
            <div id="earnings-view" class="view">
                <h2 style="margin-bottom: 1rem;">Earnings Research</h2>
                <div id="earnings-content">
                    <div class="loading">Loading earnings data...</div>
                </div>
            </div>
            
            <!-- IDEAS TAB -->
            <div id="ideas-view" class="view">
                <h2 style="margin-bottom: 1rem;">Ideas & Notes</h2>
                <div id="ideas-content">
                    <div class="loading">Loading ideas...</div>
                </div>
            </div>
            
            <!-- SCHEDULE TAB -->
            <div id="schedule-view" class="view">
                <h2 style="margin-bottom: 1rem;">Schedule</h2>
                <div id="schedule-content">
                    <div class="loading">Loading schedule...</div>
                </div>
            </div>
            
            <!-- CORPORATE TAB -->
            <div id="corporate-view" class="view">
                <h2 style="margin-bottom: 1rem;">Corporate Structure</h2>
                <div id="corporate-content">
                    <div class="loading">Loading team...</div>
                </div>
            </div>
            
            <!-- API USAGE TAB -->
            <div id="usage-view" class="view">
                <h2 style="margin-bottom: 1rem;">API Usage</h2>
                <div id="usage-content">
                    <div class="loading">Loading API data...</div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="analysis-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Analysis</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        // Global data
        let portfolioData = null;
        let analysisData = [];
        
        // Tab switching
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(viewName + '-view').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the tab
            if (viewName === 'holdings') loadHoldings();
            else if (viewName === 'analysis') loadAnalysis();
            else if (viewName === 'earnings') loadEarnings();
            else if (viewName === 'ideas') loadIdeas();
            else if (viewName === 'schedule') loadSchedule();
            else if (viewName === 'corporate') loadCorporate();
            else if (viewName === 'usage') loadUsage();
        }
        
        // Format helpers
        function formatCurrency(value) {
            if (value < 0) {
                return `($${Math.abs(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})})`;
            }
            return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function formatTimeAgo(date) {
            if (!date || isNaN(date.getTime())) return 'Never';
            const mins = Math.floor((new Date() - date) / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + ' min ago';
            if (mins < 1440) return Math.floor(mins/60) + ' hours ago';
            return Math.floor(mins/1440) + ' days ago';
        }
        
        // Toggle account breakdown
        function toggleAccounts(btn) {
            const detail = btn.nextElementSibling;
            if (detail.style.display === 'none' || detail.style.display === '') {
                detail.style.display = 'block';
                btn.textContent = btn.textContent.replace('▼', '▲');
            } else {
                detail.style.display = 'none';
                btn.textContent = btn.textContent.replace('▲', '▼');
            }
        }
        
        // ==================== HOLDINGS TAB ====================
        
        async function loadHoldings() {
            try {
                const response = await fetch('/api/portfolio');
                portfolioData = await response.json();
                renderHoldings(portfolioData);
            } catch (error) {
                document.getElementById('holdings-content').innerHTML = 
                    '<div class="card">Error loading portfolio</div>';
            }
        }
        
        function renderHoldings(data) {
            const lastRefresh = new Date(data.last_price_refresh);
            const hoursAgo = (new Date() - lastRefresh) / (1000 * 60 * 60);
            const needsAsterisk = hoursAgo > 24;
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Portfolio Holdings</h2>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">
                            Last refresh: ${formatTimeAgo(lastRefresh)}
                        </span>
                        <button class="refresh-btn" onclick="refreshPrices()">Refresh Prices</button>
                    </div>
                </div>
            `;
            
            // Stocks Section
            html += `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Stocks & ETFs</div>
                        <div class="card-value">${formatCurrency(data.totals.stocks_etfs)}</div>
                    </div>
                    <table class="portfolio-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Shares</th>
                                <th>Price${needsAsterisk ? '*' : ''}</th>
                                <th>Cost/Share</th>
                                <th>Value</th>
                                <th>P/L %</th>
                                <th>Accounts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.stocks.map(stock => {
                                const costPerShare = stock.total_cost_basis / stock.total_shares;
                                const plPct = stock.total_return_pct;
                                const plClass = plPct >= 0 ? 'positive' : 'negative';
                                const indicator = needsAsterisk ? '*' : '';
                                
                                const accountsHtml = stock.accounts.map(a => {
                                    const acctValue = a.shares * stock.price;
                                    return `${a.account}: ${formatCurrency(acctValue)}`;
                                }).join('<br>');
                                
                                return `
                                    <tr>
                                        <td><div class="ticker">${stock.ticker}</div></td>
                                        <td>${stock.total_shares.toLocaleString()}</td>
                                        <td>$${stock.price.toFixed(2)}${indicator}</td>
                                        <td>$${costPerShare.toFixed(2)}</td>
                                        <td>${formatCurrency(stock.total_value)}</td>
                                        <td class="${plClass}">${plPct >= 0 ? '+' : ''}${plPct.toFixed(1)}%</td>
                                        <td>
                                            <button class="expand-btn" onclick="toggleAccounts(this)">▼ ${stock.accounts.length}</button>
                                            <div class="accounts-detail">${accountsHtml}</div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Options Section
            html += `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Options Positions</div>
                        <div class="card-value">${formatCurrency(data.totals.options)}</div>
                    </div>
                    <table class="portfolio-table">
                        <thead>
                            <tr><th>Ticker</th><th>Type</th><th>Strike</th><th>Exp</th><th>Contracts</th><th>Premium</th><th>Value</th><th>Accounts</th></tr>
                        </thead>
                        <tbody>
                            ${data.options.map(opt => {
                                const premium = opt.total_entry_value / opt.total_contracts / 100;
                                const accountsHtml = opt.accounts.map(a => {
                                    const val = a.contracts * a.entry_premium * 100;
                                    return `${a.account}: ${formatCurrency(val)}`;
                                }).join('<br>');
                                return `
                                    <tr>
                                        <td><div class="ticker">${opt.ticker}</div></td>
                                        <td>${opt.type}</td>
                                        <td>$${opt.strike}</td>
                                        <td>${opt.expiration}</td>
                                        <td>${opt.total_contracts}</td>
                                        <td>$${premium.toFixed(3)}</td>
                                        <td>${formatCurrency(opt.current_value)}</td>
                                        <td>
                                            <button class="expand-btn" onclick="toggleAccounts(this)">▼ ${opt.accounts.length}</button>
                                            <div class="accounts-detail">${accountsHtml}<br><i>${opt.note}</i></div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Cash Section
            html += `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Cash & Cash Equivalents</div>
                        <div class="card-value">${formatCurrency(data.totals.cash_equivalents)}</div>
                    </div>
                    <table class="portfolio-table">
                        <thead><tr><th>Asset</th><th>Total</th><th>Details</th><th>Accounts</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><div class="ticker">Cash</div></td>
                                <td>${formatCurrency(data.cash.Cash.total)}</td>
                                <td>-</td>
                                <td>
                                    <button class="expand-btn" onclick="toggleAccounts(this)">▼ ${data.cash.Cash.accounts.length}</button>
                                    <div class="accounts-detail">${data.cash.Cash.accounts.map(a => `${a.account}: ${formatCurrency(a.value)}`).join('<br>')}</div>
                                </td>
                            </tr>
                            <tr>
                                <td><div class="ticker">SGOV</div></td>
                                <td>${formatCurrency(data.cash.SGOV.total)}</td>
                                <td>${data.cash.SGOV.total_shares.toFixed(2)} sh @ $${data.cash.SGOV.price.toFixed(2)}${needsAsterisk ? '*' : ''}</td>
                                <td>
                                    <button class="expand-btn" onclick="toggleAccounts(this)">▼ ${data.cash.SGOV.accounts.length}</button>
                                    <div class="accounts-detail">${data.cash.SGOV.accounts.map(a => `${a.account}: ${formatCurrency(a.value)}`).join('<br>')}</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // Total Section
            html += `
                <div class="card" style="background: var(--bg-secondary);">
                    <div class="card-header">
                        <div class="card-title">Total Portfolio</div>
                        <div class="card-value" style="font-size: 1.5rem;">${formatCurrency(data.totals.grand_total)}</div>
                    </div>
                    <div class="totals-grid">
                        <div class="total-card">
                            <div class="total-card-label">Stocks & ETFs</div>
                            <div class="total-card-value">${formatCurrency(data.totals.stocks_etfs)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Options</div>
                            <div class="total-card-value">${formatCurrency(data.totals.options)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Cash & Equivalents</div>
                            <div class="total-card-value">${formatCurrency(data.totals.cash_equivalents)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Misc</div>
                            <div class="total-card-value">${formatCurrency(data.totals.misc)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('holdings-content').innerHTML = html;
        }
        
        async function refreshPrices() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Refreshing...';
            }
            try {
                await fetch('/api/refresh-prices', {method: 'POST'});
                await loadHoldings();
            } catch (e) {
                alert('Error refreshing prices');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Refresh Prices';
                }
            }
        }
        
        // ==================== ANALYSIS TAB ====================
        
        async function loadAnalysis() {
            try {
                const response = await fetch('/api/analysis-archive');
                analysisData = await response.json();
                renderAnalysis(analysisData);
            } catch (error) {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="card">Error loading analysis</div>';
            }
        }
        
        function renderAnalysis(analyses) {
            if (!analyses || analyses.length === 0) {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="card">No analysis available</div>';
                return;
            }
            
            const html = `
                <div class="analysis-grid">
                    ${analyses.map((a, idx) => `
                        <div class="analysis-card" onclick="openAnalysisModal(${idx})">
                            <div class="analysis-card-header">
                                <div class="analysis-card-ticker">${a.ticker}</div>
                                <div class="analysis-card-grade">B+</div>
                            </div>
                            <div class="analysis-card-summary">${a.summary}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('analysis-content').innerHTML = html;
        }
        
        function filterAnalysis() {
            const searchTerm = document.getElementById('analysis-search').value.toLowerCase();
            const filtered = analysisData.filter(a => 
                a.ticker.toLowerCase().includes(searchTerm) ||
                a.summary.toLowerCase().includes(searchTerm)
            );
            renderAnalysis(filtered);
        }
        
        function openAnalysisModal(index) {
            const analysis = analysisData[index];
            if (!analysis) return;
            
            document.getElementById('modal-title').textContent = analysis.ticker + ' Analysis';
            document.getElementById('modal-body').innerHTML = analysis.full_text.replace(/\n/g, '<br>');
            document.getElementById('analysis-modal').classList.add('active');
        }
        
        function closeModal(e) {
            if (!e || e.target.id === 'analysis-modal') {
                document.getElementById('analysis-modal').classList.remove('active');
            }
        }
        
        // ==================== OTHER TABS ====================
        
        async function loadEarnings() {
            try {
                const response = await fetch('/api/earnings-research');
                const data = await response.json();
                document.getElementById('earnings-content').innerHTML = 
                    data.length > 0 
                        ? `<div class="analysis-grid">${data.map(e => `
                            <div class="analysis-card">
                                <div class="analysis-card-header">
                                    <div class="analysis-card-ticker">${e.ticker}</div>
                                    <div class="analysis-card-grade">${e.grade || 'B+'}</div>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                    ${e.date || ''} | Expected Move: ${e.expected_move || 'N/A'}
                                </div>
                                <div class="analysis-card-summary">
                                    <strong>Action:</strong> ${e.action || 'Monitor'}<br>
                                    <strong>IV Rank:</strong> ${e.iv_rank || 'N/A'}
                                </div>
                            </div>
                        `).join('')}</div>`
                        : '<div class="card">No earnings research available</div>';
            } catch (error) {
                document.getElementById('earnings-content').innerHTML = 
                    '<div class="card">Error loading earnings data</div>';
            }
        }
        
        async function loadIdeas() {
            try {
                const response = await fetch('/api/ideas');
                const data = await response.json();
                document.getElementById('ideas-content').innerHTML = 
                    data.length > 0
                        ? `<div class="analysis-grid">${data.map(i => `
                            <div class="analysis-card">
                                <div style="color: var(--accent); font-size: 0.75rem; margin-bottom: 0.5rem;">${i.category || 'Uncategorized'}</div>
                                <div class="analysis-card-summary">${i.content}</div>
                            </div>
                        `).join('')}</div>`
                        : '<div class="card">No ideas available</div>';
            } catch (error) {
                document.getElementById('ideas-content').innerHTML = 
                    '<div class="card">Error loading ideas</div>';
            }
        }
        
        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                document.getElementById('schedule-content').innerHTML = 
                    data.length > 0
                        ? `<div class="card"><table class="portfolio-table"><thead><tr><th>Date</th><th>Time</th><th>Event</th><th>Location</th></tr></thead><tbody>${data.map(e => `
                            <tr style="${e.is_today ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                                <td><strong>${e.date}</strong> ${e.is_today ? '<span style="color: var(--accent);">(Today)</span>' : ''}</td>
                                <td>${e.time || '-'}</td>
                                <td>${e.event}</td>
                                <td>${e.location || '-'}</td>
                            </tr>
                        `).join('')}</tbody></table></div>`
                        : '<div class="card">No upcoming events</div>';
            } catch (error) {
                document.getElementById('schedule-content').innerHTML = 
                    '<div class="card">Error loading schedule</div>';
            }
        }
        
        async function loadCorporate() {
            try {
                const response = await fetch('/api/corporate');
                const data = await response.json();
                document.getElementById('corporate-content').innerHTML = 
                    data.team && data.team.length > 0
                        ? `<div class="analysis-grid">${data.team.map(m => `
                            <div class="analysis-card">
                                <div class="analysis-card-header">
                                    <div class="analysis-card-ticker">${m.name}</div>
                                    <div style="color: ${m.status === 'Active' ? 'var(--positive)' : 'var(--text-secondary)'}; font-size: 0.75rem;">● ${m.status}</div>
                                </div>
                                <div style="color: var(--accent); font-size: 0.875rem; margin-bottom: 0.5rem;">${m.role}</div>
                                <div class="analysis-card-summary">
                                    ${m.department ? `<strong>Dept:</strong> ${m.department}<br>` : ''}
                                    ${m.reports_to ? `<strong>Reports to:</strong> ${m.reports_to}<br>` : ''}
                                </div>
                            </div>
                        `).join('')}</div>`
                        : '<div class="card">No corporate data available</div>';
            } catch (error) {
                document.getElementById('corporate-content').innerHTML = 
                    '<div class="card">Error loading corporate data</div>';
            }        }
        
        async function loadUsage() {
            try {
                const response = await fetch('/api/usage');
                const data = await response.json();
                const apis = Object.values(data.apis || {});
                const totalCost = data.total_estimated_cost || 0;
                
                document.getElementById('usage-content').innerHTML = 
                    apis.length > 0
                        ? `<div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Total Estimated Cost</div>
                                <div class="card-value">\$${totalCost.toFixed(2)}</div>
                            </div>
                           </div>
                           <div class="analysis-grid">${apis.map(api => `
                            <div class="analysis-card">
                                <div class="analysis-card-header">
                                    <div class="analysis-card-ticker">${api.name}</div>
                                    <div style="color: ${api.status === 'Active' ? 'var(--positive)' : 'var(--negative)'}; font-size: 0.75rem;">${api.status}</div>
                                </div>
                                <div style="color: var(--accent); font-size: 0.875rem; margin-bottom: 0.5rem;">${api.purpose}</div>
                                <div class="analysis-card-summary">
                                    <strong>Tier:</strong> ${api.tier}<br>
                                    <strong>Limit:</strong> ${api.limit}<br>
                                    <strong>Calls:</strong> ${api.calls_this_month}
                                </div>
                            </div>
                        `).join('')}</div>`
                        : '<div class="card">No API usage data available</div>';
            } catch (error) {
                document.getElementById('usage-content').innerHTML = 
                    '<div class="card">Error loading API usage</div>';
            }
        }
        
        // Load initial data
        loadHoldings();
    </script>
</body>
</html>
                            <div class="total-card-value ${data.totals.stocks_etfs < 0 ? 'negative-parens' : ''}">${formatCurrency(data.totals.stocks_etfs)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Options</div>
                            <div class="total-card-value ${data.totals.options < 0 ? 'negative-parens' : ''}">${formatCurrency(data.totals.options)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Cash & Equivalents</div>
                            <div class="total-card-value">${formatCurrency(data.totals.cash_equivalents)}</div>
                        </div>
                        <div class="total-card">
                            <div class="total-card-label">Misc</div>
                            <div class="total-card-value ${data.totals.misc < 0 ? 'negative-parens' : ''}">${formatCurrency(data.totals.misc)}</div>
                        </div>
                    </div>
                    <div class="legend">
                        <strong>Legend:</strong> 
                        * Price cached >24h ago | 
                        <span class="positive">Green</span> = Positive P/L | 
                        <span class="negative">Red</span> = Negative P/L
                    </div>
                </div>
            `;
            
            document.getElementById('holdings-content').innerHTML = html;
        }
        
        async function refreshPrices() {
            const btn = document.querySelector('.refresh-btn');
            const spinner = document.getElementById('refresh-spinner');
            const text = document.getElementById('refresh-text');
            
            if (btn) {
                btn.disabled = true;
                spinner.style.display = 'inline-block';
                text.textContent = 'Refreshing...';
            }
            try {
                await fetch('/api/refresh-prices', {method: 'POST'});
                await loadHoldings();
            } catch (e) {
                alert('Error refreshing prices');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    text.textContent = 'Refresh Prices';
                }
            }
        }
        
        // ==================== ANALYSIS ARCHIVE TAB ====================
        
        async function loadAnalysis() {
            try {
                const response = await fetch('/api/analysis-archive');
                analysisData = await response.json();
                renderAnalysis(analysisData);
            } catch (error) {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="card">Error loading analysis</div>';
            }
        }
        
        function renderAnalysis(analyses) {
            if (!analyses || analyses.length === 0) {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="card">No analysis available</div>';
                return;
            }

            const html = `
                <div class="analysis-grid">
                    ${analyses.map((a, idx) => `
                        <div class="analysis-card" onclick="openAnalysisModal(${idx})">
                            <div class="analysis-card-header">
                                <div class="analysis-card-ticker">${a.ticker}</div>
                                <div class="analysis-card-grade">B+</div>
                            </div>
                            <div class="analysis-card-summary">${a.summary}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('analysis-content').innerHTML = html;
        }

        function filterAnalysis() {
            const searchTerm = document.getElementById('analysis-search').value.toLowerCase();
            const filtered = analysisData.filter(a =>
                a.ticker.toLowerCase().includes(searchTerm) ||
                a.summary.toLowerCase().includes(searchTerm)
            );
            renderAnalysis(filtered);
        }

        function openAnalysisModal(index) {
            const analysis = analysisData[index];
            if (!analysis) return;

            document.getElementById('modal-title').textContent = analysis.ticker + ' Analysis';
            
            // Convert markdown to HTML with proper formatting
            let html = renderMarkdown(analysis.full_text);
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('analysis-modal').classList.add('active');
        }
        
        function renderMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML to prevent XSS
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Headers (h2, h3, h4)
            html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');
            
            // Bold and italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Links [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--accent);">$1</a>');
            
            // Split into lines and process lists
            const lines = html.split('\n');
            let result = [];
            let inList = false;
            let listType = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Check for unordered list item
                if (line.match(/^\s*[-*+]\s+/)) {
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    const content = line.replace(/^\s*[-*+]\s+/, '');
                    result.push(`<li>${content}</li>`);
                }
                // Check for ordered list item
                else if (line.match(/^\s*\d+\.\s+/)) {
                    if (!inList || listType !== 'ol') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    const content = line.replace(/^\s*\d+\.\s+/, '');
                    result.push(`<li>${content}</li>`);
                }
                // Empty line closes lists
                else if (line.trim() === '') {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }
                    result.push('<br>');
                }
                // Regular line
                else {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }
                    // Skip if already a header
                    if (!line.match(/^<h[234]>/)) {
                        result.push(`<p>${line}</p>`);
                    } else {
                        result.push(line);
                    }
                }
            }
            
            // Close any open list
            if (inList) {
                result.push(`</${listType}>`);
            }
            
            return result.join('');
        }
        
        function closeModal(e) {
            if (!e || e.target.id === 'analysis-modal') {
                document.getElementById('analysis-modal').classList.remove('active');
            }
        }
        
        // Load initial data
        loadHoldings();
    </script>
</body>
</html>
